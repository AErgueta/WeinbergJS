<div class="container mt-4">
    <h3 class="text-center mt-3 mb-4">‚úîÔ∏è Aceptaci√≥n de Trabajo</h3>

    <!-- Recuadro principal -->
    <div class="info-box">
        <table class="table table-bordered bg-white">
            <thead class="thead-light">
                <tr>
                    <th>Cantidad</th>
                    <th>Producto</th>
                    <th class="text-right">Precio en Bolivianos</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>{{detalle.cantidadQuo}}</td>
                    <td>{{detalle.descripcionQuo}}</td>
                    <td class="text-right">
                        {{formatCurrency (sum version.lineas "monto")}}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Seguimiento del Trabajo -->
    <div class="info-box mt-4 border border-primary rounded">
        <div class="info-title">Seguimiento del Trabajo</div>

        <!-- Aceptar Cotizaci√≥n -->
        <div class="form-row mb-3">
            <div class="col-md-6 d-flex align-items-center">
                <input type="checkbox" id="chkAprobar" class="mr-2" {{#if version.aceptada}}checked{{/if}}>
                <label for="chkAprobar" class="mb-0 text-danger font-weight-bold">Aceptar Cotizaci√≥n</label>
            </div>
            <div class="col-md-6">
                <label for="fechaPrevista" class="mb-1 font-weight-bold">üìÖ Fecha de aceptaci√≥n:</label>
                <input type="date" id="fechaAprobacion" class="form-control" value="{{fechaAceptacion}}" />
            </div>
        </div>

        <!-- Fecha prevista + botones -->
        <div class="form-row mb-4">
            <div class="col-md-6 offset-md-6">
                <label for="fechaPrevista" class="mb-1 font-weight-bold">üìÖ Fecha prevista de entrega:</label>
                <input type="date" id="fechaPrevista" class="form-control mb-3" value="{{fechaPrevistaEntrega}}" />

                <button id="btnGuardarOrden" class="btn btn-success btn-block font-weight-bold mb-2">
                    üíæ Guardar Orden de Trabajo
                </button>

                <a id="btnGenerarOrden"
                   href="/pdf/ver-orden-trabajo/{{detalle._id}}/{{versionIndex}}"
                   class="btn btn-primary btn-block font-weight-bold"
                   target="_blank">
                    üìù Generar Orden
                </a>
                <a id="btnExportarPDF"
                    href="/pdf/descargar-orden-trabajo/{{detalle._id}}/{{versionIndex}}"
                    class="btn btn-danger btn-block font-weight-bold"
                    target="_blank">
                    üìÑ Exportar a PDF
                </a>
            </div>
        </div>

       <!-- Trabajo Terminado -->
        <div class="form-row">
            <div class="col-md-6 d-flex align-items-center">
                <input type="checkbox" id="chkTerminado" class="mr-2">
                <label for="chkTerminado" class="mb-0 text-primary font-weight-bold">Trabajo Terminado</label>
            </div>
            <div class="col-md-6">
                <label for="fechaPrevista" class="mb-1 font-weight-bold">üìÖ Fecha de Terminaci√≥n:</label>
                <input type="date" id="fechaTerminado" class="form-control mb-3" />
                
                <!-- ‚úÖ Nuevo bot√≥n -->
                <button id="btnActualizarInfo" class="btn btn-warning btn-block font-weight-bold">
                    üìå Actualizar Informaci√≥n
                </button>
            </div>
        </div>
    </div>

    <!-- Campos ocultos necesarios -->
    <input type="hidden" id="customerId" value="{{customerId}}">
    <input type="hidden" id="quotationId" value="{{quotationId}}">
    <input type="hidden" id="detalleIndex" value="{{detalleIndex}}">
    <input type="hidden" id="detalleId" value="{{detalle._id}}">
    <input type="hidden" id="versionIndex" value="{{versionIndex}}">
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const chkAprobar = document.getElementById('chkAprobar');
    const fechaAprobacion = document.getElementById('fechaAprobacion');
    const fechaPrevista = document.getElementById('fechaPrevista');
    const chkTerminado = document.getElementById('chkTerminado');
    const fechaTerminado = document.getElementById('fechaTerminado');

    // üü¢ Aceptar cotizaci√≥n
    chkAprobar.addEventListener('change', () => {
        if (chkAprobar.checked) {
            const hoy = new Date().toISOString().split('T')[0];
            if (!fechaAprobacion.value) fechaAprobacion.value = hoy;
            if (!fechaPrevista.value) fechaPrevista.focus();
        } else {
            fechaAprobacion.value = '';
            fechaPrevista.value = '';
        }
    });

    // üü£ Trabajo Terminado
    chkTerminado.addEventListener('change', () => {
        if (chkTerminado.checked) {
            const hoy = new Date().toISOString().split('T')[0];
            fechaTerminado.value = hoy;
        } else {
            fechaTerminado.value = '';
        }
    });

    // üíæ Guardar Orden
    document.getElementById("btnGuardarOrden").addEventListener("click", async () => {
        const customerId = document.getElementById("customerId").value;
        const quotationId = document.getElementById("quotationId").value;
        const detalleIndex = document.getElementById("detalleIndex").value;
        const detalleId = document.getElementById("detalleId").value;
        const versionIndex = document.getElementById("versionIndex").value;

        const aceptada = document.getElementById("chkAprobar").checked;
        const fechaAceptacion = document.getElementById("fechaAprobacion").value;
        const fechaPrevistaEntrega = document.getElementById("fechaPrevista").value;
        const terminado = document.getElementById("chkTerminado").checked;
        const fechaTerminado = document.getElementById("fechaTerminado").value;

        try {
            const response = await fetch(`/guardar-orden-trabajo/${customerId}/${quotationId}/${detalleIndex}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    aceptada,
                    fechaAceptacion,
                    fechaPrevistaEntrega,
                    terminado,
                    fechaTerminado,
                    detalleId,
                    versionIndex
                })
            });

            if (response.ok) {
                alert("‚úÖ Orden de trabajo guardada correctamente.");
            } else {
                alert("‚ùå Error al guardar la orden.");
            }
        } catch (error) {
            console.error("‚ùå Error en el guardado:", error);
            alert("‚ùå Fallo al conectar con el servidor.");
        }
    });
});
</script>
