<div class="container mt-4">
    <h3 class="text-center mt-3 mb-4">âœ”ï¸ AceptaciÃ³n de Trabajo</h3>

    <!-- Recuadro principal -->
    <div class="info-box">
        <table class="table table-bordered bg-white">
            <thead class="thead-light">
                <tr>
                    <th>Cantidad</th>
                    <th>Producto</th>
                    <th class="text-right">Precio en Bolivianos</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>{{detalle.cantidadQuo}}</td>
                    <td>{{detalle.descripcionQuo}}</td>
                    <td class="text-right">
                        {{formatCurrency (sum version.lineas "monto")}}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Seguimiento del Trabajo -->
    <div class="info-box mt-4 border border-primary rounded">
        <div class="info-title">Seguimiento del Trabajo</div>

        <!-- Aceptar CotizaciÃ³n -->
        <div class="form-row mb-3">
            <div class="col-md-6 d-flex align-items-center">
                <input type="checkbox" id="chkAprobar" class="mr-2" {{#if version.aceptada}}checked{{/if}}>
                <label for="chkAprobar" class="mb-0 text-danger font-weight-bold">Aceptar CotizaciÃ³n</label>
            </div>
            <div class="col-md-6">
                <label for="fechaPrevista" class="mb-1 font-weight-bold">ğŸ“… Fecha de aceptaciÃ³n:</label>
                <input type="date" id="fechaAprobacion" class="form-control" value="{{fechaAceptacion}}" />
            </div>
        </div>

        <!-- Fecha prevista + botones -->
        <div class="form-row mb-4">
            <div class="col-md-6 offset-md-6">
                <label for="fechaPrevista" class="mb-1 font-weight-bold">ğŸ“… Fecha prevista de entrega:</label>
                <input type="date" id="fechaPrevista" class="form-control mb-3" value="{{fechaPrevistaEntrega}}" />

                <button id="btnGuardarOrden" class="btn btn-success btn-block font-weight-bold mb-2">
                    ğŸ’¾ Guardar Orden de Trabajo
                </button>

                <a id="btnGenerarOrden"
                   href="/pdf/ver-orden-trabajo/{{detalle._id}}/{{versionIndex}}"
                   class="btn btn-primary btn-block font-weight-bold"
                   target="_blank">
                    ğŸ“ Generar Orden
                </a>
                <a id="btnExportarPDF"
                    href="/pdf/descargar-orden-trabajo/{{detalle._id}}/{{versionIndex}}"
                    class="btn btn-danger btn-block font-weight-bold"
                    target="_blank">
                    ğŸ“„ Exportar a PDF
                </a>
            </div>
        </div>

       <!-- Trabajo Terminado -->
        <div class="form-row">
        <div class="col-md-6 d-flex align-items-center">
            <input type="checkbox" id="chkTerminado" class="mr-2" {{#if version.terminado}}checked{{/if}}>
            <label for="chkTerminado" class="mb-0 text-primary font-weight-bold">Trabajo Terminado</label>
        </div>
        <div class="col-md-6">
            <label for="fechaTerminado" class="mb-0">Fecha de TerminaciÃ³n:</label>
            <input type="date" id="fechaTerminado" class="form-control" value="{{fechaTerminado}}" />
        </div>
        </div>

        <!-- BotÃ³n: Actualizar trabajo terminado -->
        <div class="form-row mt-3">
        <div class="col-md-6 offset-md-6">
            <input type="hidden" id="usuario" value="{{usuarioTermina}}">
            <button id="btnActualizarTerminado" class="btn btn-info btn-block font-weight-bold">
            ğŸ”„ Actualizar informaciÃ³n
            </button>
        </div>
        </div>
    </div>

    <!-- Campos ocultos necesarios -->
    <input type="hidden" id="customerId" value="{{customerId}}">
    <input type="hidden" id="quotationId" value="{{quotationId}}">
    <input type="hidden" id="detalleIndex" value="{{detalleIndex}}">
    <input type="hidden" id="detalleId" value="{{detalle._id}}">
    <input type="hidden" id="versionIndex" value="{{versionIndex}}">
    <input type="hidden" id="usuario" value="{{user.name}}">
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const chkAprobar = document.getElementById('chkAprobar');
    const fechaAprobacion = document.getElementById('fechaAprobacion');
    const fechaPrevista = document.getElementById('fechaPrevista');
    const chkTerminado = document.getElementById('chkTerminado');
    const fechaTerminado = document.getElementById('fechaTerminado');

    // ğŸŸ¢ Aceptar cotizaciÃ³n
    chkAprobar.addEventListener('change', () => {
        if (chkAprobar.checked) {
            const hoy = new Date().toISOString().split('T')[0];
            if (!fechaAprobacion.value) fechaAprobacion.value = hoy;
            if (!fechaPrevista.value) fechaPrevista.focus();
        } else {
            fechaAprobacion.value = '';
            fechaPrevista.value = '';
        }
    });

    // ğŸŸ£ Trabajo Terminado
    chkTerminado.addEventListener('change', () => {
        if (chkTerminado.checked) {
            const hoy = new Date().toISOString().split('T')[0];
            fechaTerminado.value = hoy;
        } else {
            fechaTerminado.value = '';
        }
    });

    // ğŸ’¾ Guardar Orden de Trabajo
    document.getElementById("btnGuardarOrden").addEventListener("click", async () => {
        const customerId = document.getElementById("customerId").value;
        const quotationId = document.getElementById("quotationId").value;
        const detalleIndex = document.getElementById("detalleIndex").value;
        const detalleId = document.getElementById("detalleId").value;
        const versionIndex = document.getElementById("versionIndex").value;

        const aceptada = chkAprobar.checked;
        const fechaAceptacion = fechaAprobacion.value;
        const fechaPrevistaEntrega = fechaPrevista.value;

        try {
            const response = await fetch(`/guardar-orden-trabajo/${customerId}/${quotationId}/${detalleIndex}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    aceptada,
                    fechaAceptacion,
                    fechaPrevistaEntrega,
                    detalleId,
                    versionIndex
                })
            });

            if (response.ok) {
                alert("âœ… Orden de trabajo guardada correctamente.");
            } else {
                alert("âŒ Error al guardar la orden.");
            }
        } catch (error) {
            console.error("âŒ Error en el guardado:", error);
            alert("âŒ Fallo al conectar con el servidor.");
        }
    });

    // ğŸ”„ Actualizar Trabajo Terminado
    document.getElementById("btnActualizarTerminado").addEventListener("click", async () => {
        const detalleId = document.getElementById("detalleId").value;
        const versionIndex = document.getElementById("versionIndex").value;
        const terminado = chkTerminado.checked;
        const fechaTerminadoValue = fechaTerminado.value;
        const usuarioTermina = document.getElementById("usuario").value;

        try {
            const response = await fetch(`/marcar-trabajo-terminado/${detalleId}/${versionIndex}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    terminado,
                    fechaTerminado: fechaTerminadoValue,
                    usuarioTermina
                })
            });

            if (response.ok) {
                alert("âœ… InformaciÃ³n de trabajo terminado actualizada.");
            } else {
                alert("âŒ No se pudo actualizar trabajo terminado.");
            }
        } catch (error) {
            console.error("âŒ Error al actualizar trabajo terminado:", error);
            alert("âŒ Fallo al conectar con el servidor.");
        }
    });
});
</script>

